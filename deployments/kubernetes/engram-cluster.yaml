# Complete Kubernetes manifest for 3-node Engram cluster with SWIM
# Designed for Kind but works on any Kubernetes cluster

apiVersion: v1
kind: Namespace
metadata:
  name: engram-cluster
  labels:
    app: engram
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: engram-cluster-config
  namespace: engram-cluster
data:
  config.toml: |
    [feature_flags]
    spreading_api_beta = true

    [server]
    http_bind = "0.0.0.0"

    [memory_spaces]
    default_space = "default"
    bootstrap_spaces = ["default"]

    [persistence]
    data_root = "/data"
    hot_capacity = 100_000
    warm_capacity = 1_000_000
    cold_capacity = 10_000_000

    [cluster]
    enabled = true

    [cluster.discovery]
    type = "dns"
    service = "engram-headless.engram-cluster.svc.cluster.local"
    port = 7946
    refresh_interval = "30s"

    [cluster.swim]
    ping_interval = "1s"
    ack_timeout = "600ms"
    suspicion_timeout = "2s"
    indirect_probes = 2
    gossip_batch = 6

    [cluster.replication]
    factor = 2
    timeout = "1s"
    placement = "random"

    [cluster.network]
    swim_bind = "0.0.0.0:7946"
    api_bind = "0.0.0.0:50051"
---
apiVersion: v1
kind: Service
metadata:
  name: engram-headless
  namespace: engram-cluster
  labels:
    app: engram
spec:
  clusterIP: None
  publishNotReadyAddresses: true
  selector:
    app: engram
  ports:
    - name: swim
      port: 7946
      targetPort: 7946
      protocol: UDP
    - name: grpc
      port: 50051
      targetPort: 50051
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: engram-http
  namespace: engram-cluster
  labels:
    app: engram
spec:
  type: NodePort
  selector:
    app: engram
  ports:
    - name: http
      port: 7432
      targetPort: 7432
      nodePort: 30432
      protocol: TCP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: engram
  namespace: engram-cluster
  labels:
    app: engram
spec:
  serviceName: engram-headless
  replicas: 3
  selector:
    matchLabels:
      app: engram
  template:
    metadata:
      labels:
        app: engram
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "7432"
        prometheus.io/path: "/metrics"
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app: engram
                topologyKey: kubernetes.io/hostname

      containers:
        - name: engram
          image: engram/engram:latest
          imagePullPolicy: IfNotPresent

          command: ["/usr/local/bin/engram"]
          args:
            - "start"
            - "--http-port=7432"
            - "--grpc-port=50051"

          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: XDG_CONFIG_HOME
              value: "/config"
            - name: RUST_LOG
              value: "info"
            - name: RUST_BACKTRACE
              value: "1"

          ports:
            - containerPort: 7432
              name: http
              protocol: TCP
            - containerPort: 50051
              name: grpc
              protocol: TCP
            - containerPort: 7946
              name: swim
              protocol: UDP

          volumeMounts:
            - name: data
              mountPath: /data
            - name: config
              mountPath: /config/engram

          livenessProbe:
            exec:
              command:
                - /usr/local/bin/engram
                - status
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            exec:
              command:
                - /usr/local/bin/engram
                - status
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 2

          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"

      volumes:
        - name: config
          configMap:
            name: engram-cluster-config

  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
